<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TECHS応募フォーム</title>
    <style>
      body{font-family:'Noto Sans JP',sans-serif;padding:20px}
      h2{color:#ff6a00}
      label{display:block;margin-top:10px;font-weight:600}
      input,textarea,select{
        width:100%;
        padding:8px;
        margin-top:4px;
        border-radius:8px;
        border:1px solid #ccc;
        box-sizing:border-box;
      }
      button{
        width:100%;
        padding:10px;
        margin-top:20px;
        border:none;
        background:#ff6a00;
        color:#fff;
        font-weight:bold;
        border-radius:10px;
      }
      #thanks p{
        margin-top:10px;
        line-height:1.6;
        text-align:center;
      }
    </style>
  </head>
  <body>
    <h2>TECHS応募フォーム</h2>
    <p>下記に入力して送信ボタンを押してください。</p>

    <!-- フォームエリア -->
    <div id="formArea">
      <label>お名前<span style="color:#e00;font-size:0.85em;">（必須）</span></label>
      <input id="name">

      <label>電話番号<span style="color:#e00;font-size:0.85em;">（必須）</span></label>
      <input id="tel">

      <label>メールアドレス（任意）</label>
      <input id="email">

      <!-- ↓ここをプルダウンに変更 -->
      <label>警備のご経験</label>
      <select id="experience">
        <option value="未経験">未経験</option>
        <option value="1年未満">1年未満</option>
        <option value="1〜3年">1〜3年</option>
        <option value="3年以上">3年以上</option>
      </select>

      <label>資格（任意）</label>
      <input id="license">

      <label>居住区（任意）</label>
      <input id="address">

      <label>志望動機（任意）</label>
      <textarea id="motivation"></textarea>

      <button id="sendBtn" type="button">送信</button>
    </div>

    <!-- サンクス画面 -->
    <div id="thanks" style="display:none;">
      <p>
        ご応募ありがとうございます！<br>
        担当者より順次ご連絡いたします。
      </p>
      <button id="okBtn" type="button">OK</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      const LIFF_ID = "2008387877-jJ8Z4gW9";
      const API_URL = "https://script.google.com/macros/s/AKfycbxFcdgkGByu58opgWU7McugBrhX5DgUG6D_4Rn53tXEax-DebCBy1MIEJTRoLL2WsID/exec"; // WebアプリのURL
      const SECRET = "TECHS2025";

      async function init() {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();

        const btn = document.getElementById("sendBtn");
        const formArea = document.getElementById("formArea");
        const thanks = document.getElementById("thanks");
        const okBtn = document.getElementById("okBtn");

        // 送信ボタン
        btn.addEventListener("click", async () => {
          const name = v("name");
          const tel = v("tel");
          const email = v("email");
          const experience = v("experience"); // select でも v() でOK

          // ▼バリデーション
          const errors = [];

          if (!name) {
            errors.push("お名前を入力してください。");
          }
          if (!tel) {
            errors.push("電話番号を入力してください。");
          }
          if (email) {
            // めちゃシンプルに「@ と . が両方含まれているか」だけチェック
            if (!(email.includes("@") && email.includes("."))) {
              errors.push("メールアドレスの形式が正しくありません。");
            }
          }

          if (errors.length > 0) {
            alert(errors.join("\n"));
            return; // ここで送信中処理には進まない
          }

          const data = {
            token: SECRET,
            form: {
              name: name,
              phone: tel,
              email: email,
              experience: experience,
              license: v("license"),
              address: v("address"),
              motivation: v("motivation")
            },
            user: {
              userId: profile.userId,
              displayName: profile.displayName
            }
          };

          btn.disabled = true;
          btn.textContent = "送信中...";

          try {
            // 既存GASに合わせて no-cors & ヘッダ無し
            await fetch(API_URL, {
              method: "POST",
              mode: "no-cors",
              body: JSON.stringify(data)
            });

            formArea.style.display = "none";
            thanks.style.display = "block";
          } catch (err) {
            alert("送信エラー：" + err);
            btn.disabled = false;
            btn.textContent = "送信";
          }
        });

        // OKボタン → トークにメッセージ → 画面を閉じる
        okBtn.addEventListener("click", async () => {
          try {
            await liff.sendMessages([
              {
                type: "text",
                text: "ご応募ありがとうございます！\n担当者より追ってご連絡いたします。（TECHS）"
              }
            ]);
          } catch (e) {
            console.error(e);
          } finally {
            if (liff.isInClient()) {
              liff.closeWindow();
            }
          }
        });
      }

      function v(id) {
        const el = document.getElementById(id);
        return el ? el.value.trim() : "";
      }

      init();
    </script>
  </body>
</html>
